<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Licenças</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="sidebar">
    <div class="logo"><img src="src/logo.png" style="width: 90%;"></div>
    <div class="nav">
      <div class="nav-item" onclick="voltarParaAplicacoes()">← Voltar</div>
      <div class="nav-item active">Licenças</div>
    </div>
    <div class="footer">
      <img id="userAvatar" src="https://res.cloudinary.com/dylkeqcms/image/upload/v1762125098/default_uqhrk3.jpg" alt="Avatar">
      <div class="footer-text">
        <h3 id="userName">Usuário</h3>
        <p id="userEmail">email@example.com</p>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <h2 id="appTitle">Licenças da Aplicação</h2>
      <div class="actions">
        <button class="btn primary" onclick="abrirModalLicenca()">+ Nova Licença</button>
      </div>
    </div>

    <div class="content">
      <!-- Informações da Aplicação -->
      <div class="app-info" id="appInfo" style="background: var(--panel); padding: 20px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid #1f1f1f;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <img id="appImage" src="" alt="App" style="width: 60px; height: 60px; border-radius: var(--radius); object-fit: cover;">
          <div>
            <h3 id="appName">Nome da Aplicação</h3>
            <p id="appDetails" style="color: var(--muted); font-size: 14px; margin: 5px 0 0 0;"></p>
          </div>
        </div>
      </div>

      <!-- Lista de Licenças -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Chave da Licença</th>
              <th>Status</th>
              <th>Tag</th>
              <th>Duração (dias)</th>
              <th>Ativada em</th>
              <th>Expira em</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="licensesTable">
            <tr><td colspan="7" class="no-data">Carregando licenças...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Nova Licença -->
  <div class="modal" id="modalLicenca">
    <div class="modal-content" style="width: 400px;">
      <h3>Nova Licença</h3>
      
      <div class="form-group">
        <label for="licenseDuration">Duração (dias)</label>
        <input type="number" id="licenseDuration" value="30" min="1">
        <small>Duração em dias a partir da primeira ativação</small>
      </div>

      <div class="form-group">
        <label>Usuário</label>
        <input type="text" id="userInfoDisplay" readonly style="background: var(--panel); cursor: not-allowed;">
        <small>Licença será associada ao usuário logado</small>
      </div>

      <div class="form-group">
        <label>Tag da Aplicação</label>
        <input type="text" id="appTagDisplay" readonly style="background: var(--panel); cursor: not-allowed;">
        <small>Esta tag será usada no prefixo da chave da licença</small>
      </div>

      <div class="modal-buttons">
        <button class="btn primary" onclick="criarLicenca()">Criar Licença</button>
        <button class="btn cancel" onclick="fecharModal('modalLicenca')">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Notificações -->
  <div class="notif-container" id="notifContainer"></div>

  <script>
    const apiUrl = "http://localhost:3000/api";
    let currentApp = null;
    let currentUserId = null;

    // === Função de notificação ===
    function notify(type, message) {
      const div = document.createElement("div");
      div.className = `notif-msg ${type}`;
      div.innerText = message;
      notifContainer.appendChild(div);
      setTimeout(() => div.remove(), 4000);
    }

    // === Navegação ===
    function voltarParaAplicacoes() {
      window.location.href = 'dashboard.html';
    }

    // === Modal ===
    function abrirModalLicenca() { 
      document.getElementById('modalLicenca').classList.add("active");
    }
    
    function fecharModal(modalId) { 
      document.getElementById(modalId).classList.remove("active"); 
    }

    // === Carregar informações do usuário ===
    async function carregarUsuario() {
      const userId = localStorage.getItem("userId");
      
      if (!userId) {
        notify("error", "Usuário não autenticado");
        setTimeout(voltarParaAplicacoes, 2000);
        return;
      }

      currentUserId = userId;

      try {
        const res = await fetch(`${apiUrl}/users/${userId}`);
        if (res.ok) {
          const user = await res.json();
          document.getElementById("userName").textContent = user.name;
          document.getElementById("userEmail").textContent = user.email;
          document.getElementById("userAvatar").src = user.avatarUrl;
          document.getElementById("userInfoDisplay").value = `${user.name} (ID: ${userId})`;
          
          // Salva no localStorage para próxima vez
          localStorage.setItem("userName", user.name);
          localStorage.setItem("userEmail", user.email);
          if (user.avatarUrl) {
            localStorage.setItem("userAvatar", user.avatarUrl);
          }
        } else {
          throw new Error('Erro ao carregar usuário');
        }
      } catch (err) {
        console.error('Erro ao carregar dados do usuário:', err);
        notify("error", "Erro ao carregar dados do usuário");
      }
    }

    // === Carregar aplicação selecionada ===
    function carregarAplicacao() {
      const appData = localStorage.getItem('selectedApp');
      
      if (!appData) {
        notify("error", "Nenhuma aplicação selecionada");
        setTimeout(voltarParaAplicacoes, 2000);
        return;
      }

      currentApp = JSON.parse(appData);
      
      // Atualizar interface com dados da aplicação
      document.getElementById('appTitle').textContent = `Licenças - ${currentApp.name}`;
      document.getElementById('appName').textContent = currentApp.name;
      document.getElementById('appImage').src = currentApp.image;
      document.getElementById('appDetails').textContent = 
        `Tag: ${currentApp.config.tag} | Duração padrão: ${currentApp.config.default_duration} dias`;
      
      // Preencher a tag da aplicação no modal
      document.getElementById('appTagDisplay').value = currentApp.config.tag;
      
      // Preencher duração padrão no modal
      document.getElementById('licenseDuration').value = currentApp.config.default_duration;
    }

    // === Carregar Licenças do Usuário Logado PARA A APLICAÇÃO ATUAL ===
    async function carregarLicencas() {
      if (!currentUserId || !currentApp) {
        document.getElementById('licensesTable').innerHTML = '<tr><td colspan="7" class="no-data">Dados insuficientes</td></tr>';
        return;
      }

      try {
        const res = await fetch(`${apiUrl}/licenses/user/${currentUserId}`);
        
        if (!res.ok) throw new Error(`Erro ${res.status}`);
        
        const allLicenses = await res.json();
        
        // Filtrar licenças pela tag da aplicação atual
        const licenses = allLicenses.filter(license => 
          license.appTag === currentApp.config.tag
        );
        
        const tbody = document.getElementById('licensesTable');
        
        if (!licenses || licenses.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="no-data">Nenhuma licença encontrada para esta aplicação</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        licenses.forEach(license => {
          const statusClass = `license-status ${license.status}`;
          const statusText = {
            'inactive': 'Inativa',
            'active': 'Ativa',
            'expired': 'Expirada'
          }[license.status] || license.status;

          const activatedAt = license.activatedAt 
            ? new Date(license.activatedAt).toLocaleDateString('pt-BR')
            : '-';

          const expirationDate = license.expirationDate
            ? new Date(license.expirationDate).toLocaleDateString('pt-BR')
            : '-';

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><code>${license.licenseKey}</code></td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td><span class="app-tag">${license.appTag}</span></td>
            <td>${license.durationDays} dias</td>
            <td>${activatedAt}</td>
            <td>${expirationDate}</td>
            <td>
              <button class="btn" onclick="copiarLicenca('${license.licenseKey}')" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">Copiar</button>
              <button class="btn" onclick="validarLicenca('${license.licenseKey}')" style="padding: 5px 10px; font-size: 12px; margin-right: 5px; background: #27ae60;">Validar</button>
              <button class="btn" onclick="deletarLicenca('${license.licenseKey}')" style="padding: 5px 10px; font-size: 12px; background: #e74c3c;">Deletar</button>
            </td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Erro ao carregar licenças:', err);
        document.getElementById('licensesTable').innerHTML = '<tr><td colspan="7" class="no-data">Erro ao carregar licenças</td></tr>';
      }
    }

    // === Criar Licença ===
    async function criarLicenca() {
      if (!currentUserId || !currentApp) {
        notify("error", "Dados insuficientes");
        return;
      }

      const durationDays = parseInt(document.getElementById("licenseDuration").value);
      const appTag = currentApp.config.tag; // Usa a tag da aplicação atual

      if (!durationDays) {
        notify("info", "Preencha a duração");
        return;
      }

      try {
        const res = await fetch(`${apiUrl}/licenses`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            userId: currentUserId, 
            durationDays,
            appTag 
          })
        });

        const result = await res.json();

        if (!res.ok) throw new Error(result.error || `Erro ${res.status}`);

        notify("success", "Licença criada com sucesso!");
        fecharModal('modalLicenca');
        carregarLicencas();
      } catch (err) {
        console.error('Erro ao criar licença:', err);
        notify("error", err.message);
      }
    }

    // === Validar Licença ===
    async function validarLicenca(licenseKey) {
      try {
        const res = await fetch(`${apiUrl}/licenses/${licenseKey}/validate`, {
          method: "POST"
        });

        const result = await res.json();

        if (!res.ok) {
          notify("error", result.error || "Erro ao validar licença");
          return;
        }

        if (result.status === 'activated') {
          notify("success", `Licença ativada! Expira em: ${new Date(result.expirationDate).toLocaleDateString('pt-BR')}`);
        } else if (result.status === 'active') {
          notify("info", `Licença ativa! Expira em ${result.expiresIn} dias`);
        }

        // Recarrega a lista para atualizar os status
        carregarLicencas();
      } catch (err) {
        console.error('Erro ao validar licença:', err);
        notify("error", "Erro ao validar licença");
      }
    }

    // === Copiar Licença ===
    async function copiarLicenca(licenseKey) {
      try {
        await navigator.clipboard.writeText(licenseKey);
        notify("success", "Chave da licença copiada!");
      } catch (err) {
        console.error('Erro ao copiar licença:', err);
        notify("error", "Erro ao copiar licença");
      }
    }

    // === Deletar Licença ===
    async function deletarLicenca(licenseKey) {
      if (!confirm('Tem certeza que deseja deletar esta licença?')) return;

      try {
        const res = await fetch(`${apiUrl}/licenses/${licenseKey}`, { 
          method: "DELETE" 
        });

        if (!res.ok) throw new Error(`Erro ${res.status}`);

        notify("success", "Licença deletada com sucesso!");
        carregarLicencas();
      } catch (err) {
        console.error('Erro ao deletar licença:', err);
        notify("error", "Erro ao deletar licença");
      }
    }

    // === Inicialização ===
    document.addEventListener('DOMContentLoaded', function() {
      carregarUsuario();
      carregarAplicacao();
      carregarLicencas();
      
      document.getElementById('modalLicenca').addEventListener('click', function(e) {
        if (e.target === this) fecharModal('modalLicenca');
      });
    });
  </script>

  <style>
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #333;
      border-radius: var(--radius);
      background: var(--hover);
      color: var(--text);
      font-size: 14px;
    }

    .form-group small {
      display: block;
      margin-top: 4px;
      color: var(--muted);
      font-size: 11px;
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: var(--accent);
      text-align: center;
    }

    .license-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .license-status.inactive { background: #95a5a6; color: white; }
    .license-status.active { background: #27ae60; color: white; }
    .license-status.expired { background: #e74c3c; color: white; }

    .app-tag {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      background: var(--accent);
      color: white;
      text-transform: uppercase;
    }

    code {
      background: var(--hover);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</body>
</html>