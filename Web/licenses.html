<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style.css">
  <title>Key Auther - Licenses</title>
  <style>
    /* === MODAL === */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      z-index: 999;
      animation: fadeIn 0.2s ease-in-out;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: var(--panel);
      padding: 24px;
      border-radius: var(--radius);
      width: 380px;
      box-shadow: 0 0 25px rgba(0,0,0,0.6);
      text-align: center;
      transform: scale(0.95);
      animation: scaleUp 0.2s ease-out forwards;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleUp { to { transform: scale(1); } }

    .modal-content h3 { margin-bottom: 10px; color: var(--accent); }
    .modal-content p { color: var(--text); margin-bottom: 10px; }

    .modal-inputs input {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border: none;
      border-radius: var(--radius);
      background: var(--hover);
      color: var(--text);
      font-size: 14px;
    }

    .modal-buttons {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div>
      <div class="logo">Key Auth</div>
      <nav class="nav">
        <a href="./licenses.html"><div class="nav-item active">Licenses</div></a>
        <a href="./users.html"><div class="nav-item">Users</div></a>
        <a href="./documentation.html"><div class="nav-item">Documentation</div></a>
        <a href="./settings.html"><div class="nav-item">Settings</div></a>
      </nav>
    </div>
    <!-- Sidebar Footer será preenchido dinamicamente -->
    <div class="footer" id="sidebarUser"></div>
  </aside>

  <!-- Main -->
  <main class="main">
    <section class="content">
      <h2>Licenças</h2>
      <div class="actions">
        <button id="createLicenseBtn" class="btn primary">Create License</button>
        <button id="deleteLicenseBtn" class="btn">Delete License</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Select</th>
              <th>License</th>
              <th>Creation Date</th>
              <th>Generated By</th>
              <th>Type</th>
              <th>Expires</th>
            </tr>
          </thead>
          <tbody id="licenseTableBody">
            <tr>
              <td colspan="6" class="no-data">No data available</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ==== MODAL ==== -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <p id="modalMessage"></p>
      <div id="modalInputs" class="modal-inputs"></div>
      <div class="modal-buttons">
        <button id="modalCancel" class="btn">Cancelar</button>
        <button id="modalConfirm" class="btn primary">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://keyer.camposcloud.app/api";
    const tableBody = document.getElementById("licenseTableBody");
    const createBtn = document.getElementById("createLicenseBtn");
    const deleteBtn = document.getElementById("deleteLicenseBtn");
    const sidebarUserDiv = document.getElementById("sidebarUser");

    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
    const modalInputs = document.getElementById("modalInputs");
    const modalCancel = document.getElementById("modalCancel");
    const modalConfirm = document.getElementById("modalConfirm");

    const loggedUserId = localStorage.getItem("userId"); // userId salvo no login

    if (!loggedUserId) {
      alert("Usuário não logado!");
      window.location.href = "./login.html";
    }

    // === Modal genérico ===
    function openModal({ title, message, inputs = [], confirmText = "Confirmar", onConfirm, forceOnCancel = false }) {
      modalTitle.textContent = title;
      modalMessage.innerHTML = message;
      modalInputs.innerHTML = "";
      inputs.forEach(i => {
        const input = document.createElement("input");
        input.type = i.type || "text";
        input.placeholder = i.placeholder;
        input.id = i.id;
        modalInputs.appendChild(input);
      });
      modal.classList.add("active");
      modalConfirm.textContent = confirmText;

      const confirmHandler = () => {
        const values = {};
        inputs.forEach(i => values[i.id] = document.getElementById(i.id).value);
        onConfirm && onConfirm(values);
        closeModal();
      };

      const cancelHandler = () => {
        if (forceOnCancel && onConfirm) onConfirm();
        closeModal();
      };

      modalConfirm.onclick = confirmHandler;
      modalCancel.onclick = cancelHandler;
    }

    function closeModal() {
      modal.classList.remove("active");
      modalInputs.innerHTML = "";
      modalConfirm.onclick = null;
    }

    // === Carregar informações do usuário na sidebar ===
    async function loadSidebarUser() {
      try {
        const res = await fetch(`${API_URL}/users/${loggedUserId}`);
        if (!res.ok) throw new Error("Erro ao buscar dados do usuário");
        const user = await res.json();

        sidebarUserDiv.innerHTML = `
          <a href="profile.html">
            <div class="footer">
              <img src="${user.avatarUrl || '../src/images/default.jpg'}" style="height: 40px; border-radius: 100%;">
              <div class="footer-text" style="display: flex; flex-direction: column;">
                <h3>${user.name}</h3>
                <p>${user.plan || "Tester Plan"}</p>
              </div>
            </div>
          </a>
        `;
      } catch (error) {
        console.error("Erro ao carregar sidebar:", error);
      }
    }

    // === Carregar Licenças do usuário logado ===
    async function loadLicenses() {
      try {
        const [licensesRes, usersRes] = await Promise.all([
          fetch(`${API_URL}/licenses/user/${loggedUserId}`), // apenas do usuário logado
          fetch(`${API_URL}/users`)
        ]);

        if (!licensesRes.ok || !usersRes.ok) throw new Error("Erro ao buscar dados da API");

        const licenses = await licensesRes.json();
        const users = await usersRes.json();

        const userMap = {};
        users.forEach(u => userMap[u.id] = u.name || u.username || "Desconhecido");

        tableBody.innerHTML = "";
        if (licenses.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="no-data">No data available</td></tr>`;
          return;
        }

        licenses.forEach(lic => {
          const userName = userMap[lic.userId] || "Usuário não encontrado";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input type="radio" name="selectedLicense" value="${lic.licenseKey}"></td>
            <td>${lic.licenseKey}</td>
            <td>${new Date(lic.createdAt).toLocaleDateString('pt-BR')}</td>
            <td>${userName}</td>
            <td>${lic.type}</td>
            <td>${lic.expirationDate}</td>
          `;
          tableBody.appendChild(tr);
        });

      } catch (error) {
        console.error("Erro ao carregar licenças:", error);
      }
    }

    // === Criar Licença ===
    createBtn.addEventListener("click", () => {
      openModal({
        title: "Criar Licença",
        message: "Preencha os dados abaixo:",
        inputs: [
          { id: "type", placeholder: "Tipo (basic, premium, pro)" },
          { id: "durationDays", placeholder: "Duração (em dias)", type: "number" }
        ],
        onConfirm: async (values) => {
          const { type, durationDays } = values;
          if (!type || !durationDays) return openModal({ title:"Erro", message:"Preencha todos os campos.", confirmText:"Ok" });

          try {
            const res = await fetch(`${API_URL}/licenses`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId: loggedUserId, type, durationDays: parseInt(durationDays) })
            });
            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || "Erro ao criar licença");
            }

            openModal({ title:"Sucesso", message:"Licença criada com sucesso!", confirmText:"Ok", onConfirm: loadLicenses, forceOnCancel:true });
          } catch (error) {
            openModal({ title:"Erro", message:"Erro: "+error.message, confirmText:"Ok" });
          }
        }
      });
    });

    // === Deletar Licença ===
    deleteBtn.addEventListener("click", () => {
      const selected = document.querySelector("input[name='selectedLicense']:checked");
      if (!selected) return openModal({ title:"Aviso", message:"Selecione uma licença.", confirmText:"Ok" });

      const key = selected.value;

      openModal({
        title: "Confirmar Exclusão",
        message: `Tem certeza que deseja deletar a licença <b>${key}</b>?`,
        confirmText: "Deletar",
        onConfirm: async () => {
          try {
            const res = await fetch(`${API_URL}/licenses/${key}`, { method: "DELETE" });
            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || "Erro ao deletar licença");
            }
            openModal({ title:"Sucesso", message:"Licença deletada!", confirmText:"Ok", onConfirm: loadLicenses, forceOnCancel:true });
          } catch (error) {
            openModal({ title:"Erro", message:"Erro: "+error.message, confirmText:"Ok" });
          }
        }
      });
    });

    // === Inicialização ===
    loadSidebarUser();
    loadLicenses();
  </script>
</body>
</html>
